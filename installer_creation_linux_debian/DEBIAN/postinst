#!/bin/bash
set -e

# Устанавливаем правильные права после установки
chmod -R 755 /opt/calculator
chmod +x /usr/local/bin/calculator

# Патчинг для Linux (ваш существующий код можно оставить)
MAIN_PY="/opt/calculator/main.py"

# Проверяем, нужно ли применять патч
if grep -q "self.FormMain.iconbitmap(default=os.path.join(self.application_path, 'icon.ico'))" "$MAIN_PY"; then
    echo "Applying Linux icon fix..."
    python3 << 'EOF'
import re

with open('/opt/calculator/main.py', 'r') as f:
    content = f.read()

old_code = '''        self.FormMain.iconbitmap(default=os.path.join(self.application_path, 'icon.ico'))'''

new_code = '''        # Исправлено для Linux
        try:
            icon_path = os.path.join(self.application_path, 'icon.png')
            if os.path.exists(icon_path):
                img = tk.PhotoImage(file=icon_path)
                self.FormMain.iconphoto(True, img)
            else:
                icon_ico_path = os.path.join(self.application_path, 'icon.ico')
                if os.path.exists(icon_ico_path):
                    self.FormMain.iconbitmap(icon_ico_path)
        except Exception as e:
            print("Ошибка загрузки иконки:", e)'''

content = content.replace(old_code, new_code)

with open('/opt/calculator/main.py', 'w') as f:
    f.write(content)

print("Linux icon fix applied successfully")
EOF
fi

echo "Calculator installed successfully!"