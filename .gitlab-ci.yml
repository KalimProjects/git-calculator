stages:
  - test
  - build

variables:
  PROJECT_NAME: "git-calculator"
  VERSION: "1.2"

# Тестирование
test_application:
  stage: test
  image: python:3.9
  before_script:
    - apt-get update && apt-get install -y curl
    - python --version
  script:
    - echo "Downloading source code from releases branch..."
    - curl -s -L -o main.py "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/main.py"
    - curl -s -L -o functions.py "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/functions.py"
    - curl -s -L -o icon.ico "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/icon.ico"
    - echo "Downloading tests from test branch..."
    - mkdir -p tests
    - curl -s -L -o tests/test_calc.py "https://raw.githubusercontent.com/KalimProjects/git-calculator/test/tests/test_calc.py"
    - curl -s -L -o tests/test_functions.py "https://raw.githubusercontent.com/KalimProjects/git-calculator/test/tests/test_functions.py"
    - echo "# Init file" > tests/__init__.py
    - echo "Running unit tests..."
    - python tests/test_calc.py
    - python tests/test_functions.py
  artifacts:
    paths:
      - main.py
      - functions.py
      - icon.ico
      - tests/
    expire_in: 1 hour
  only:
    - main
    - releases

# Сборка Debian пакета
build_linux_package:
  stage: build
  image: ubuntu:20.04
  before_script:
    - apt-get update
    - apt-get install -y curl dpkg-dev python3
  script:
    - echo "Building Debian package..."
    - curl -s -L -o main.py "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/main.py"
    - curl -s -L -o functions.py "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/functions.py"
    - curl -s -L -o icon.png "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/icon.png"
    - curl -s -L -o calculator.desktop "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/calculator.desktop"
    - mkdir -p DEBIAN
    - curl -s -L -o DEBIAN/control "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/installer_creation_linux_debian/DEBIAN/control"
    - curl -s -L -o DEBIAN/postinst "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/installer_creation_linux_debian/DEBIAN/postinst"
    - chmod +x DEBIAN/postinst
    - mkdir -p package/DEBIAN
    - mkdir -p package/opt/calculator
    - mkdir -p package/usr/local/bin
    - mkdir -p package/usr/share/applications
    - cp DEBIAN/control package/DEBIAN/
    - cp DEBIAN/postinst package/DEBIAN/
    - cp main.py functions.py icon.png package/opt/calculator/
    - cp calculator.desktop package/usr/share/applications/
    - echo "#!/bin/bash" > package/usr/local/bin/calculator
    - echo "cd /opt/calculator" >> package/usr/local/bin/calculator
    - echo "python3 main.py" >> package/usr/local/bin/calculator
    - chmod +x package/usr/local/bin/calculator
    - chmod -R 755 package/opt/calculator
    - chmod 755 package/DEBIAN/postinst
    - dpkg-deb --build package calculator_1.2_all.deb
    - echo "Debian package created"
  artifacts:
    paths:
      - calculator_1.2_all.deb
    expire_in: 1 week
  only:
    - releases

# Сборка Windows установщика
build_windows_installer:
  stage: build
  tags:
    - windows
  before_script:
    - choco install python -y
    - choco install innosetup -y
    - refreshenv
    - python --version
    - pip install pyinstaller
  script:
    - echo "Building Windows installer..."
    - curl -s -L -o main.py "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/main.py"
    - curl -s -L -o functions.py "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/functions.py"
    - curl -s -L -o icon.ico "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/icon.ico"
    - curl -s -L -o installer.iss "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/installer_creation/installer.iss"
    - echo "Fixing paths in installer script..."
    - '((Get-Content -Path "installer.iss" -Raw) -replace ''#define OutputDir \"\.\.\\installer\"'', ''#define OutputDir \"installer\"'') | Set-Content -Path "installer.iss"'
    - '((Get-Content -Path "installer.iss" -Raw) -replace ''#define IconNameSource \"\.\.\\icon\.ico\"'', ''#define IconNameSource \"icon.ico\"'') | Set-Content -Path "installer.iss"'
    - '((Get-Content -Path "installer.iss" -Raw) -replace ''Source: \"\{[^\}]*\}"'', ''Source: \"dist\\main.exe\"; DestName: \"GitCalculator.exe\"'') | Set-Content -Path "installer.iss"'
    - echo "Building with PyInstaller..."
    - pyinstaller --onefile --windowed --icon="icon.ico" --add-data="icon.ico;." main.py functions.py
    - echo "Creating installer with Inno Setup..."
    - iscc installer.iss
    - if (Test-Path "installer\GitCalculatorSetup.exe") { Copy-Item "installer\GitCalculatorSetup.exe" "GitCalculatorSetup_1.2.exe" }
  artifacts:
    paths:
      - GitCalculatorSetup_1.2.exe
    expire_in: 1 week
  only:
    - releases

# Финальный этап
deploy_artifacts:
  stage: build
  image: alpine:latest
  script:
    - echo "All artifacts are available for download"
    - echo "Pipeline completed successfully!"
  dependencies:
    - build_linux_package
    - build_windows_installer
  only:
    - releases