stages:
  - test
  - build

variables:
  PROJECT_NAME: "git-calculator"
  VERSION: "1.2"

# Тестирование
test_application:
  stage: test
  image: python:3.9
  before_script:
    - apt-get update && apt-get install -y curl
    - python --version
  script:
    - echo "Downloading source code from releases branch..."
    - curl -s -L -o main.py "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/main.py"
    - curl -s -L -o functions.py "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/functions.py"
    - curl -s -L -o icon.ico "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/icon.ico"
    - echo "Downloading tests from test branch..."
    - mkdir -p tests
    - curl -s -L -o tests/test_calc.py "https://raw.githubusercontent.com/KalimProjects/git-calculator/test/tests/test_calc.py"
    - curl -s -L -o tests/test_functions.py "https://raw.githubusercontent.com/KalimProjects/git-calculator/test/tests/test_functions.py"
    - echo "# Init file" > tests/__init__.py
    - echo "Running unit tests..."
    - |
      for test_file in tests/test_*.py; do
        if [ -f "$test_file" ]; then
          echo "Running $test_file..."
          python "$test_file" || exit 1
        fi
      done
  artifacts:
    paths:
      - main.py
      - functions.py
      - icon.ico
      - tests/
    expire_in: 1 hour
  only:
    - main
    - releases

# Сборка Debian пакета
build_linux_package:
  stage: build
  image: ubuntu:20.04
  before_script:
    - apt-get update
    - apt-get install -y curl dpkg-dev python3
  script:
    - echo "Building Debian package..."
    - curl -s -L -o main.py "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/main.py"
    - curl -s -L -o functions.py "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/functions.py"
    - curl -s -L -o icon.png "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/icon.png"
    - curl -s -L -o calculator.desktop "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/calculator.desktop"
    - mkdir -p DEBIAN
    - curl -s -L -o DEBIAN/control "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/installer_creation_linux_debian/DEBIAN/control"
    - curl -s -L -o DEBIAN/postinst "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/installer_creation_linux_debian/DEBIAN/postinst"
    - chmod +x DEBIAN/postinst
    - mkdir -p package/DEBIAN
    - mkdir -p package/opt/calculator
    - mkdir -p package/usr/local/bin
    - mkdir -p package/usr/share/applications
    - cp DEBIAN/control package/DEBIAN/
    - cp DEBIAN/postinst package/DEBIAN/
    - cp main.py functions.py icon.png package/opt/calculator/
    - cp calculator.desktop package/usr/share/applications/
    - |
      cat > package/usr/local/bin/calculator << 'EOF'
      #!/bin/bash
      cd /opt/calculator
      python3 main.py
      EOF
    - chmod +x package/usr/local/bin/calculator
    - chmod -R 755 package/opt/calculator
    - chmod 755 package/DEBIAN/postinst
    - dpkg-deb --build package calculator_${VERSION}_all.deb
    - echo "Debian package created: calculator_${VERSION}_all.deb"
  artifacts:
    paths:
      - calculator_*.deb
    expire_in: 1 week
  only:
    - releases

# Сборка Windows установщика
build_windows_installer:
  stage: build
  tags:
    - windows
  before_script:
    - choco install python -y
    - choco install innosetup -y
    - refreshenv
    - python --version
    - pip install pyinstaller
  script:
    - echo "Building Windows installer..."
    - curl -s -L -o main.py "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/main.py"
    - curl -s -L -o functions.py "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/functions.py"
    - curl -s -L -o icon.ico "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/icon.ico"
    - curl -s -L -o installer.iss "https://raw.githubusercontent.com/KalimProjects/git-calculator/releases/installer_creation/installer.iss"
    - echo "Fixing paths in installer script..."
    - |
      $content = Get-Content -Path "installer.iss" -Encoding UTF8
      $content = $content -replace '#define OutputDir "\.\.\\installer"', '#define OutputDir "installer"'
      $content = $content -replace '#define IconNameSource "\.\.\\icon\.ico"', '#define IconNameSource "icon.ico"'
      $content = $content -replace 'Source: "{[^}]*}"', 'Source: "dist\main.exe"; DestName: "GitCalculator.exe"'
      $content | Set-Content -Path "installer.iss" -Encoding UTF8
    - echo "Building with PyInstaller..."
    - pyinstaller --onefile --windowed --icon="icon.ico" --add-data="icon.ico;." main.py functions.py
    - echo "Creating installer with Inno Setup..."
    - iscc installer.iss
    - if (Test-Path "installer\GitCalculatorSetup.exe") { Copy-Item "installer\GitCalculatorSetup.exe" "GitCalculatorSetup_${env:VERSION}.exe" }
  artifacts:
    paths:
      - GitCalculatorSetup_*.exe
      - installer/
    expire_in: 1 hour
  only:
    - releases

# Финальный этап
deploy_artifacts:
  stage: build
  image: alpine:latest
  script:
    - echo "All artifacts are available for download:"
    - echo "- Windows: GitCalculatorSetup_${VERSION}.exe"
    - echo "- Linux: calculator_${VERSION}_all.deb"
    - echo "Pipeline completed successfully!"
  dependencies:
    - build_linux_package
    - build_windows_installer
  only:
    - releases